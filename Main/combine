import pygame
import os
import math
import sys

pygame.init()
screen = pygame.display.set_mode((620, 480))
pygame.display.set_caption("Pawland Boy")
clock = pygame.time.Clock()

# Load assets
map_image = pygame.image.load(os.path.join("rynn/Map.png")).convert()

# Game settings
camera_width, camera_height = 320, 180
camera = pygame.Rect(0, 0, camera_width, camera_height)
zoom_surface = pygame.Surface((camera_width, camera_height))
player_position = pygame.Vector2(320, 180)
speed = 2
restricted_zones = []

# Day-night cycle
overlay = pygame.Surface(screen.get_size(), pygame.SRCALPHA)
time_counter = 0
cycle_speed = (2 * math.pi) / 30  # 30-second cycle

# Minimap settings
minimap_radius = 80
minimap_zoom_factor = 0.5
minimap_pos = (minimap_radius + 10, minimap_radius + 10)
minimap_border_color = (0, 0, 0)
minimap_border_width = 2
player_minimap_color = (255, 50, 50)
minimap_mask = pygame.Surface((minimap_radius * 2, minimap_radius * 2), pygame.SRCALPHA)
pygame.draw.circle(minimap_mask, (255, 255, 255), (minimap_radius, minimap_radius), minimap_radius)

# Frame dimensions
FRAME_WIDTH, FRAME_HEIGHT = 200, 200

# Load sprite sheets
walk_sheet = pygame.image.load("minting/character.png").convert_alpha()
attack_sheet = pygame.image.load("minting/attack.png").convert_alpha()

def load_frames(sheet, frame_width, frame_height, row, num_frames):
    frames = []
    for i in range(num_frames):
        rect = pygame.Rect(i * frame_width, row * frame_height, frame_width, frame_height)
        frame = sheet.subsurface(rect)
        frames.append(frame)
    return frames

# Walking animations
walk_down = load_frames(walk_sheet, FRAME_WIDTH, FRAME_HEIGHT, 0, 3)
walk_up = load_frames(walk_sheet, FRAME_WIDTH, FRAME_HEIGHT, 1, 4)
walk_left = load_frames(walk_sheet, FRAME_WIDTH, FRAME_HEIGHT, 2, 4)
walk_right = load_frames(walk_sheet, FRAME_WIDTH, FRAME_HEIGHT, 3, 4)

# Attack animations
attack_right = load_frames(attack_sheet, FRAME_WIDTH, FRAME_HEIGHT, 0, 4)
attack_left = load_frames(attack_sheet, FRAME_WIDTH, FRAME_HEIGHT, 1, 4)

# Animation state
frame = 0
attack_frame = 0
direction = 'down'
attacking = False

# Main loop
running = True
while running:
    dt = clock.tick(60) / 1000

    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False
        elif event.type == pygame.KEYDOWN:
            if event.key == pygame.K_EQUALS:
                minimap_zoom_factor = min(4.0, minimap_zoom_factor + 0.1)
            elif event.key == pygame.K_MINUS:
                minimap_zoom_factor = max(0.5, minimap_zoom_factor - 0.1)

    # Movement
    new_position = player_position.copy()
    keys = pygame.key.get_pressed()
    move_distance = speed * dt * 60
    moving = False

    if not attacking and keys[pygame.K_SPACE]:
        attacking = True
        attack_frame = 0

    if attacking:
        if direction == 'left':
            current_sprite = attack_left[attack_frame // 2]
        else:
            current_sprite = attack_right[attack_frame // 2]
        attack_frame += 1
        if attack_frame // 2 >= len(attack_right):
            attacking = False
    else:
        if keys[pygame.K_w]:
            new_position.y -= move_distance
            direction = 'up'
            moving = True
        if keys[pygame.K_s]:
            new_position.y += move_distance
            direction = 'down'
            moving = True
        if keys[pygame.K_a]:
            new_position.x -= move_distance
            direction = 'left'
            moving = True
        if keys[pygame.K_d]:
            new_position.x += move_distance
            direction = 'right'
            moving = True

        if direction == 'down':
            current_sprite = walk_down[frame % len(walk_down)]
        elif direction == 'up':
            current_sprite = walk_up[frame % len(walk_up)]
        elif direction == 'left':
            current_sprite = walk_left[frame % len(walk_left)]
        elif direction == 'right':
            current_sprite = walk_right[frame % len(walk_right)]

        if moving:
            frame += 1
        else:
            frame = 0

    # Bounds and restriction
    new_position.x = max(0, min(new_position.x, map_image.get_width()))
    new_position.y = max(0, min(new_position.y, map_image.get_height()))
    player_rect = pygame.Rect(new_position.x - 2, new_position.y - 2, 4, 4)
    if not any(zone.colliderect(player_rect) for zone in restricted_zones):
        player_position = new_position

    # Camera update
    camera.center = player_position
    camera.clamp_ip(map_image.get_rect())

    # Render world
    zoom_surface.fill((0, 0, 0))
    zoom_surface.blit(map_image, (0, 0), camera)
    zoomed_view = pygame.transform.scale(zoom_surface, screen.get_size())
    screen.blit(zoomed_view, (0, 0))

    # Draw character (centered)
    sprite_x = screen.get_width() // 2 - FRAME_WIDTH // 2
    sprite_y = screen.get_height() // 2 - FRAME_HEIGHT // 2
    screen.blit(current_sprite, (sprite_x, sprite_y))

    # Minimap
    minimap_surface = pygame.Surface((minimap_radius * 2, minimap_radius * 2), pygame.SRCALPHA)
    mini_camera_size = minimap_radius * 2 / minimap_zoom_factor
    mini_camera = pygame.Rect(0, 0, mini_camera_size, mini_camera_size)
    mini_camera.center = player_position
    mini_camera.clamp_ip(map_image.get_rect())
    mini_view = map_image.subsurface(mini_camera).copy()
    scaled_mini_view = pygame.transform.scale(mini_view, (minimap_radius * 2, minimap_radius * 2))
    minimap_surface.blit(scaled_mini_view, (0, 0))
    masked_minimap = minimap_surface.copy()
    masked_minimap.blit(minimap_mask, (0, 0), special_flags=pygame.BLEND_RGBA_MULT)
    pygame.draw.circle(masked_minimap, player_minimap_color, (minimap_radius, minimap_radius), 3)
    pygame.draw.circle(masked_minimap, minimap_border_color, (minimap_radius, minimap_radius), minimap_radius, minimap_border_width)
    screen.blit(masked_minimap, (minimap_pos[0] - minimap_radius, minimap_pos[1] - minimap_radius))

    # Day-night overlay
    time_counter += dt
    alpha = int((math.sin(time_counter * cycle_speed) + 1) / 2 * 150)
    overlay.fill((0, 0, 0, alpha))
    screen.blit(overlay, (0, 0))

    pygame.display.flip()

pygame.quit()
sys.exit()